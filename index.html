<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>3D Viewer with Attribute Filter</title>
  <style>
    body { margin: 0; overflow: hidden; }
    #ui {
      position: absolute;
      top: 10px; left: 10px;
      background: rgba(255,255,255,0.9);
      padding: 10px;
      border-radius: 6px;
      font-family: sans-serif;
    }
    select { margin: 5px 0; }
  </style>
</head>
<body>
<div id="ui">
  <label for="keySelect">Key:</label>
  <select id="keySelect"></select><br>
  
  <label for="valueSelect">Value:</label>
  <select id="valueSelect"></select>
</div>
<script type="module">
import * as THREE from './three.module.js';
import { OrbitControls } from './OrbitControls.js';

// ----- SCENE SETUP -----
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

const controls = new OrbitControls(camera, renderer.domElement);
camera.position.set(0,2,5);

// Light
scene.add(new THREE.AmbientLight(0xffffff, 0.8));

// ----- SAMPLE GEOMETRY WITH ATTRIBUTES -----
function makePanel(name, key, value, x) {
  const geo = new THREE.BoxGeometry(1,1,0.1);
  const mat = new THREE.MeshStandardMaterial({color:0x888888});
  const mesh = new THREE.Mesh(geo, mat);
  mesh.position.x = x;
  mesh.name = name;
  mesh.userData[key] = value;
  scene.add(mesh);
  return mesh;
}

// Example panels with CW_1.00_PNL values
makePanel("PanelA","CW_1.00_PNL","A1", -2);
makePanel("PanelB","CW_1.00_PNL","A2", 0);
makePanel("PanelC","CW_1.00_PNL","A2", 2);
makePanel("PanelD","CW_1.00_PNL","B1", 4);

// ----- UI HANDLING -----
const keySelect = document.getElementById("keySelect");
const valueSelect = document.getElementById("valueSelect");

// Collect all keys
const meshes = scene.children.filter(o => o.isMesh);
const keys = [...new Set(meshes.flatMap(m => Object.keys(m.userData)))];

// Fill key dropdown
keys.forEach(k => {
  let opt = document.createElement("option");
  opt.value = k;
  opt.textContent = k;
  keySelect.appendChild(opt);
});

// When key changes → populate values
keySelect.addEventListener("change", () => {
  const key = keySelect.value;
  const values = [...new Set(meshes.map(m => m.userData[key]).filter(Boolean))];
  
  valueSelect.innerHTML = "";
  values.forEach(v => {
    let opt = document.createElement("option");
    opt.value = v;
    opt.textContent = v;
    valueSelect.appendChild(opt);
  });
});

// Highlight function
function highlight(key, value) {
  meshes.forEach(m => {
    if (m.userData[key] === value) {
      m.material.color.set(0xff0000); // highlight red
    } else {
      m.material.color.set(0x888888); // reset gray
    }
  });
}

// When value changes → highlight
valueSelect.addEventListener("change", () => {
  highlight(keySelect.value, valueSelect.value);
});

// Initialize with first key
keySelect.dispatchEvent(new Event("change"));

// ----- RENDER LOOP -----
function animate() {
  requestAnimationFrame(animate);
  renderer.render(scene, camera);
}
animate();

</script>
</body>
</html>
